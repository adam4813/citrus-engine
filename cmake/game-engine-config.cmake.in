@PACKAGE_INIT@

include(CMakeFindDependencyMacro)

# Include the engine's cmake modules for platform detection and settings
list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_LIST_DIR}")

include(Platform)
include(CompilerSettings)

if (PLATFORM_WASM)
    include(Emscripten)
endif ()

# Find required dependencies that the engine needs
find_dependency(glfw3)
find_dependency(glm)
find_dependency(flecs)
find_dependency(spdlog)
find_dependency(nlohmann_json)
find_dependency(imgui)

if(PLATFORM_NATIVE)
    find_dependency(glad)
endif()

# Include the appropriate exported targets based on platform
if(PLATFORM_WASM)
    # Look for WASM-specific targets
    if(EXISTS "${CMAKE_CURRENT_LIST_DIR}/game-engine-targets-wasm.cmake")
        include("${CMAKE_CURRENT_LIST_DIR}/game-engine-targets-wasm.cmake")
    else()
        # Fallback to generic targets
        include("${CMAKE_CURRENT_LIST_DIR}/game-engine-targets.cmake")
    endif()
else()
    # Look for native-specific targets
    if(EXISTS "${CMAKE_CURRENT_LIST_DIR}/game-engine-targets-native.cmake")
        include("${CMAKE_CURRENT_LIST_DIR}/game-engine-targets-native.cmake")
    else()
        # Fallback to generic targets
        include("${CMAKE_CURRENT_LIST_DIR}/game-engine-targets.cmake")
    endif()
endif()

# Helper function to setup asset copying (the only custom functionality needed)
function(game_engine_setup_assets target_name assets_dir)
    if(PLATFORM_WASM)
        # Preload assets for WASM
        target_link_options(${target_name} PRIVATE
            --preload-file ${assets_dir}@/assets
        )

        # Copy assets for WASM build
        add_custom_command(TARGET ${target_name} PRE_LINK
            COMMAND ${CMAKE_COMMAND} -E copy_directory
            ${assets_dir}
            ${CMAKE_CURRENT_BINARY_DIR}/assets
            COMMENT "Copying assets for WASM build"
            VERBATIM
        )

        # Add serve target
        add_custom_target(serve-${target_name}
            COMMAND ${CMAKE_COMMAND} -E echo "Serving on http://localhost:8080/"
            COMMAND python -m http.server 8080
            WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
            DEPENDS ${target_name}
            USES_TERMINAL
            COMMENT "Start a local HTTP server for WASM output"
        )
    endif()

    if(PLATFORM_NATIVE)
        # Copy assets to build directory for native builds
        add_custom_command(TARGET ${target_name} POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_directory
            ${assets_dir}
            $<TARGET_FILE_DIR:${target_name}>/assets
            COMMENT "Copying assets to build directory"
        )
    endif()
endfunction()

check_required_components(game-engine)
